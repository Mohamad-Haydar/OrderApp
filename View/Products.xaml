<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="OrderApp.View.Products"
             xmlns:model="clr-namespace:OrderApp.Model"
             xmlns:viewmodel="clr-namespace:OrderApp.ViewModel"
             x:DataType="viewmodel:ProductsViewModel"
             BackgroundColor="{DynamicResource BackgroundColor}"
             x:Name="productspage"
             Title="Products">

    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior
     EventName="Appearing"
     Command="{Binding InitCommand}"
     BindingContext="{Binding Source={x:Reference productspage}, Path=BindingContext}"/>
    </ContentPage.Behaviors>

    <AbsoluteLayout>
        <!-- Main Grid (Search + Products) -->
        <Grid Padding="10" RowDefinitions="Auto,*"
          AbsoluteLayout.LayoutBounds="0,0,1,1"
          AbsoluteLayout.LayoutFlags="All">

            <!-- Row 0 the Search bar -->
            <SearchBar Placeholder="Search products..."
                   Text="{Binding SearchText}"
                   Grid.ColumnSpan="2"
                   Margin="0,0,0,10"
                   FontAttributes="Italic"
                   BackgroundColor="#f2f2f2"
                   PlaceholderColor="#888"
                   TextColor="Black"
                   FontSize="14"/>

            <!-- Products List -->
            <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Products}"
                        SelectionMode="None"
                        RemainingItemsThreshold="3"
                        RemainingItemsThresholdReachedCommand="{Binding LoadMoreProductsCommand}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:Product">
                        <Grid Grid.ColumnSpan="2">
                            <Border HeightRequest="125" Margin="0,5">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16"/>
                                </Border.StrokeShape>
                                <Grid ColumnDefinitions="90,*">
                                    <Image Source="{Binding ImageUrl}" Grid.Column="0" WidthRequest="70" HeightRequest="70"/>
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" HorizontalOptions="Start">
                                        <Label Text="{Binding Name}" FontSize="20"/>
                                        <Label Text="{Binding Description}" LineBreakMode="TailTruncation" FontSize="12" WidthRequest="90"/>
                                        <Label Text="{Binding Quantity, StringFormat='Quantity: {0}'}" FontSize="12"/>
                                        <Button Text="Edit" WidthRequest="70" Margin="0,5" HorizontalOptions="Start"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ProductsViewModel}}, Path=EditProductCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Floating Add Button -->
            <Button Text="+" FontSize="30"
                Grid.Row="1"
                WidthRequest="60" HeightRequest="60"
                CornerRadius="30"
                Margin="0,0,10,10"
                VerticalOptions="End"
                HorizontalOptions="End"
                Command="{Binding AddProductCommand}"/>
        </Grid>

        <!-- Dark glass overlay behind suggestions (covers everything below search bar) -->
        <!--<BoxView IsVisible="{Binding SuggestionsVisible}"
                Color="Black"
                 x:Name="OverlayBox"
                AbsoluteLayout.LayoutBounds="0,50,1,1"
                AbsoluteLayout.LayoutFlags="WidthProportional,HeightProportional"                   
                ZIndex="9">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding HideSuggestionsCommand}" />
            </BoxView.GestureRecognizers>
        </BoxView>-->
        <!-- Suggestions Container with glass effect -->
        <Frame IsVisible="{Binding SuggestionsVisible}"
         BackgroundColor="white"
         BorderColor="#CCCCCC"
         CornerRadius="8"
         Padding="0"
         HasShadow="True"
         AbsoluteLayout.LayoutBounds="0,50,1,200"
         AbsoluteLayout.LayoutFlags="WidthProportional"
         ZIndex="10">

            <CollectionView x:Name="SuggestionsList"
                      ItemsSource="{Binding Suggestions}"
                      BackgroundColor="Transparent">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="x:String">
                        <Grid Padding="15,10">
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer
                              Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ProductsViewModel}}, Path=SelectSuggestionCommand}"
                              CommandParameter="{Binding}"/>
                            </Grid.GestureRecognizers>

                            <Label Text="{Binding}" 
                             FontSize="14"
                             TextColor="{DynamicResource TextColor}"
                             VerticalOptions="Center"/>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Frame>
    </AbsoluteLayout>
</ContentPage>